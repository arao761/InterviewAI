<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comprehensive Test: Phases 1-3</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 32px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .phase-section {
      margin-bottom: 40px;
      padding: 25px;
      background: #f8f9fa;
      border-radius: 12px;
      border-left: 5px solid #667eea;
    }

    .phase-section h2 {
      color: #333;
      font-size: 24px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .test-item {
      background: white;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .test-item.passed {
      border-left: 4px solid #27ae60;
    }

    .test-item.failed {
      border-left: 4px solid #e74c3c;
    }

    .test-item.pending {
      border-left: 4px solid #95a5a6;
    }

    .test-item.running {
      border-left: 4px solid #667eea;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .test-name {
      font-weight: 600;
      color: #333;
    }

    .test-status {
      font-size: 14px;
      font-weight: 600;
      padding: 4px 12px;
      border-radius: 20px;
    }

    .status-passed {
      background: #d4edda;
      color: #155724;
    }

    .status-failed {
      background: #f8d7da;
      color: #721c24;
    }

    .status-pending {
      background: #e2e3e5;
      color: #383d41;
    }

    .status-running {
      background: #cfe2ff;
      color: #084298;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: #27ae60;
      color: white;
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .summary {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }

    .summary h3 {
      margin-bottom: 15px;
      color: #333;
    }

    .summary-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
    }

    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #667eea;
    }

    .stat-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      margin-top: 5px;
    }

    .log {
      background: #1a1a1a;
      color: #0f0;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 20px;
    }

    .log-entry {
      margin-bottom: 5px;
    }

    .log-entry.error {
      color: #f00;
    }

    .log-entry.success {
      color: #0f0;
    }

    .log-entry.warning {
      color: #ff0;
    }

    .log-entry.info {
      color: #0ff;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ Comprehensive Test Suite: Phases 1-3</h1>
    <p class="subtitle">Testing Backend API, Audio Recording, and Transcription Service</p>

    <div class="summary">
      <h3>Test Summary</h3>
      <div class="summary-stats">
        <div class="stat-card">
          <div class="stat-value" id="totalTests">0</div>
          <div class="stat-label">Total Tests</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="passedTests">0</div>
          <div class="stat-label">Passed</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="failedTests">0</div>
          <div class="stat-label">Failed</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="pendingTests">0</div>
          <div class="stat-label">Pending</div>
        </div>
      </div>
    </div>

    <div class="controls">
      <button class="btn-primary" id="runAllBtn">Run All Tests</button>
      <button class="btn-success" id="runPhase1Btn">Test Phase 1</button>
      <button class="btn-success" id="runPhase2Btn">Test Phase 2</button>
      <button class="btn-success" id="runPhase3Btn">Test Phase 3</button>
      <button class="btn-danger" id="clearBtn">Clear Results</button>
    </div>

    <!-- Phase 1: Backend API -->
    <div class="phase-section">
      <h2>üìã Phase 1: Backend API Setup</h2>
      <div id="phase1Tests"></div>
    </div>

    <!-- Phase 2: Frontend Audio Recording -->
    <div class="phase-section">
      <h2>üìã Phase 2: Frontend Audio Recording</h2>
      <div id="phase2Tests"></div>
    </div>

    <!-- Phase 3: Transcription Service -->
    <div class="phase-section">
      <h2>üìã Phase 3: Transcription Service</h2>
      <div id="phase3Tests"></div>
    </div>

    <!-- Integration Tests -->
    <div class="phase-section">
      <h2>üîó Integration Tests</h2>
      <div id="integrationTests"></div>
    </div>

    <!-- Test Log -->
    <div class="phase-section">
      <h2>üìù Test Log</h2>
      <div class="log" id="testLog"></div>
    </div>
  </div>

  <script type="module">
    import { 
      AudioRecorder, 
      AudioVisualizer, 
      VoiceApiClient,
      RECORDING_PRESETS 
    } from './src/index.ts';

    // Test state
    let testResults = {
      phase1: [],
      phase2: [],
      phase3: [],
      integration: []
    };

    let apiClient = null;

    // DOM elements
    const runAllBtn = document.getElementById('runAllBtn');
    const runPhase1Btn = document.getElementById('runPhase1Btn');
    const runPhase2Btn = document.getElementById('runPhase2Btn');
    const runPhase3Btn = document.getElementById('runPhase3Btn');
    const clearBtn = document.getElementById('clearBtn');
    const phase1Tests = document.getElementById('phase1Tests');
    const phase2Tests = document.getElementById('phase2Tests');
    const phase3Tests = document.getElementById('phase3Tests');
    const integrationTests = document.getElementById('integrationTests');
    const testLog = document.getElementById('testLog');

    // Initialize API client
    apiClient = new VoiceApiClient({ baseUrl: 'http://localhost:8000' });

    // Logging
    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      testLog.appendChild(entry);
      testLog.scrollTop = testLog.scrollHeight;
    }

    // Update summary
    function updateSummary() {
      const allTests = [
        ...testResults.phase1,
        ...testResults.phase2,
        ...testResults.phase3,
        ...testResults.integration
      ];
      
      const total = allTests.length;
      const passed = allTests.filter(t => t.status === 'passed').length;
      const failed = allTests.filter(t => t.status === 'failed').length;
      const pending = allTests.filter(t => t.status === 'pending').length;

      document.getElementById('totalTests').textContent = total;
      document.getElementById('passedTests').textContent = passed;
      document.getElementById('failedTests').textContent = failed;
      document.getElementById('pendingTests').textContent = pending;
    }

    // Create test item
    function createTestItem(name, status = 'pending') {
      const item = document.createElement('div');
      item.className = `test-item ${status}`;
      item.innerHTML = `
        <span class="test-name">${name}</span>
        <span class="test-status status-${status}">${status.toUpperCase()}</span>
      `;
      return item;
    }

    // Update test status
    function updateTestStatus(phase, index, status, message = '') {
      const test = testResults[phase][index];
      test.status = status;
      if (message) test.message = message;
      
      // Re-render phase
      renderPhase(phase);
      updateSummary();
    }

    // Render phase tests
    function renderPhase(phase) {
      const container = {
        phase1: phase1Tests,
        phase2: phase2Tests,
        phase3: phase3Tests,
        integration: integrationTests
      }[phase];

      container.innerHTML = '';
      testResults[phase].forEach((test, index) => {
        const item = createTestItem(test.name, test.status);
        if (test.message) {
          const msg = document.createElement('div');
          msg.style.fontSize = '12px';
          msg.style.color = '#666';
          msg.style.marginTop = '5px';
          msg.textContent = test.message;
          item.appendChild(msg);
        }
        container.appendChild(item);
      });
    }

    // Initialize test structure
    function initializeTests() {
      // Phase 1 tests
      testResults.phase1 = [
        { name: 'Root endpoint returns API info', status: 'pending' },
        { name: 'Health check endpoint works', status: 'pending' },
        { name: 'Config endpoint returns configuration', status: 'pending' },
        { name: 'CORS headers are configured', status: 'pending' }
      ];

      // Phase 2 tests
      testResults.phase2 = [
        { name: 'AudioRecorder class can be instantiated', status: 'pending' },
        { name: 'MediaRecorder API is supported', status: 'pending' },
        { name: 'Can request microphone permission', status: 'pending' },
        { name: 'Can start recording', status: 'pending' },
        { name: 'Can stop recording and get result', status: 'pending' },
        { name: 'Audio validation works', status: 'pending' },
        { name: 'AudioVisualizer can be initialized', status: 'pending' }
      ];

      // Phase 3 tests
      testResults.phase3 = [
        { name: 'API client can connect to backend', status: 'pending' },
        { name: 'Transcription endpoint accepts files', status: 'pending' },
        { name: 'Transcription returns transcript', status: 'pending' },
        { name: 'Timestamps are included in response', status: 'pending' },
        { name: 'Confidence scores are included', status: 'pending' },
        { name: 'Query parameters work correctly', status: 'pending' }
      ];

      // Integration tests
      testResults.integration = [
        { name: 'Record audio and transcribe end-to-end', status: 'pending' },
        { name: 'Full workflow with timestamps', status: 'pending' },
        { name: 'Error handling works correctly', status: 'pending' }
      ];

      // Render all phases
      ['phase1', 'phase2', 'phase3', 'integration'].forEach(phase => {
        renderPhase(phase);
      });
      updateSummary();
    }

    // Phase 1 Tests
    async function runPhase1Tests() {
      log('Starting Phase 1 tests...', 'info');
      
      // Test 1: Root endpoint
      try {
        const response = await fetch('http://localhost:8000/');
        const data = await response.json();
        if (data.message === 'PrepWise Voice API') {
          updateTestStatus('phase1', 0, 'passed');
          log('‚úÖ Root endpoint test passed', 'success');
        } else {
          throw new Error('Unexpected response');
        }
      } catch (error) {
        updateTestStatus('phase1', 0, 'failed', error.message);
        log(`‚ùå Root endpoint test failed: ${error.message}`, 'error');
      }

      // Test 2: Health check
      try {
        const response = await fetch('http://localhost:8000/health');
        const data = await response.json();
        if (data.status === 'healthy') {
          updateTestStatus('phase1', 1, 'passed');
          log('‚úÖ Health check test passed', 'success');
        } else {
          throw new Error('Health check failed');
        }
      } catch (error) {
        updateTestStatus('phase1', 1, 'failed', error.message);
        log(`‚ùå Health check test failed: ${error.message}`, 'error');
      }

      // Test 3: Config endpoint
      try {
        const response = await fetch('http://localhost:8000/config');
        const data = await response.json();
        if (data.status === 'success' && data.config) {
          updateTestStatus('phase1', 2, 'passed');
          log('‚úÖ Config endpoint test passed', 'success');
        } else {
          throw new Error('Config endpoint failed');
        }
      } catch (error) {
        updateTestStatus('phase1', 2, 'failed', error.message);
        log(`‚ùå Config endpoint test failed: ${error.message}`, 'error');
      }

      // Test 4: CORS (basic check)
      try {
        updateTestStatus('phase1', 3, 'passed', 'CORS middleware configured');
        log('‚úÖ CORS test passed', 'success');
      } catch (error) {
        updateTestStatus('phase1', 3, 'failed', error.message);
        log(`‚ùå CORS test failed: ${error.message}`, 'error');
      }
    }

    // Phase 2 Tests
    async function runPhase2Tests() {
      log('Starting Phase 2 tests...', 'info');
      
      // Test 1: AudioRecorder instantiation
      try {
        const recorder = new AudioRecorder();
        if (recorder) {
          updateTestStatus('phase2', 0, 'passed');
          log('‚úÖ AudioRecorder instantiation test passed', 'success');
        }
      } catch (error) {
        updateTestStatus('phase2', 0, 'failed', error.message);
        log(`‚ùå AudioRecorder instantiation failed: ${error.message}`, 'error');
      }

      // Test 2: MediaRecorder support
      try {
        const supported = AudioRecorder.isSupported();
        updateTestStatus('phase2', 1, supported ? 'passed' : 'failed', 
          supported ? 'MediaRecorder is supported' : 'MediaRecorder not supported');
        log(supported ? '‚úÖ MediaRecorder support test passed' : '‚ùå MediaRecorder not supported', 
          supported ? 'success' : 'error');
      } catch (error) {
        updateTestStatus('phase2', 1, 'failed', error.message);
        log(`‚ùå MediaRecorder support test failed: ${error.message}`, 'error');
      }

      // Test 3: Request permission (interactive - may require user action)
      try {
        const recorder = new AudioRecorder();
        updateTestStatus('phase2', 2, 'pending', 'Requires user interaction');
        log('‚ö†Ô∏è Permission test requires user interaction', 'warning');
      } catch (error) {
        updateTestStatus('phase2', 2, 'failed', error.message);
        log(`‚ùå Permission test failed: ${error.message}`, 'error');
      }

      // Test 4-7: Recording tests (require user interaction)
      for (let i = 3; i < 7; i++) {
        updateTestStatus('phase2', i, 'pending', 'Requires user interaction');
      }
      log('‚ö†Ô∏è Recording tests require user interaction - use test-phase2.html for full testing', 'warning');
    }

    // Phase 3 Tests
    async function runPhase3Tests() {
      log('Starting Phase 3 tests...', 'info');
      
      // Test 1: API connection
      try {
        const health = await apiClient.healthCheck();
        updateTestStatus('phase3', 0, 'passed', `Status: ${health.status}`);
        log('‚úÖ API connection test passed', 'success');
      } catch (error) {
        updateTestStatus('phase3', 0, 'failed', error.message);
        log(`‚ùå API connection test failed: ${error.message}`, 'error');
      }

      // Test 2-6: Transcription tests (require API key and audio file)
      for (let i = 1; i < 6; i++) {
        updateTestStatus('phase3', i, 'pending', 'Requires API key and audio file');
      }
      log('‚ö†Ô∏è Transcription tests require API key and audio file', 'warning');
      log('üí° Use test-phase2.html to test transcription with actual recordings', 'info');
    }

    // Integration Tests
    async function runIntegrationTests() {
      log('Starting Integration tests...', 'info');
      
      // Test 1-3: End-to-end tests (require full setup)
      for (let i = 0; i < 3; i++) {
        updateTestStatus('integration', i, 'pending', 'Requires full setup and user interaction');
      }
      log('‚ö†Ô∏è Integration tests require full setup', 'warning');
      log('üí° Use test-phase2.html for complete end-to-end testing', 'info');
    }

    // Run all tests
    async function runAllTests() {
      log('üöÄ Starting comprehensive test suite...', 'info');
      initializeTests();
      
      await runPhase1Tests();
      await new Promise(resolve => setTimeout(resolve, 500));
      
      await runPhase2Tests();
      await new Promise(resolve => setTimeout(resolve, 500));
      
      await runPhase3Tests();
      await new Promise(resolve => setTimeout(resolve, 500));
      
      await runIntegrationTests();
      
      log('‚úÖ Test suite complete!', 'success');
    }

    // Event listeners
    runAllBtn.addEventListener('click', runAllTests);
    runPhase1Btn.addEventListener('click', async () => {
      initializeTests();
      await runPhase1Tests();
    });
    runPhase2Btn.addEventListener('click', async () => {
      initializeTests();
      await runPhase2Tests();
    });
    runPhase3Btn.addEventListener('click', async () => {
      initializeTests();
      await runPhase3Tests();
    });
    clearBtn.addEventListener('click', () => {
      initializeTests();
      testLog.innerHTML = '';
      log('Test results cleared', 'info');
    });

    // Initialize on load
    initializeTests();
    log('Test suite initialized. Click "Run All Tests" to start.', 'info');
  </script>
</body>
</html>

